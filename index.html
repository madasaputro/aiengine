<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perception Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-card {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .step-card.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .symbol-btn.selected, .edit-mode-btn.selected {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            border-color: #3b82f6; /* border-blue-600 */
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #dc2626; /* bg-red-600 */
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s, top 0.3s;
            font-weight: 500;
        }
        .toast.show {
            opacity: 1;
            top: 40px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="toast" class="toast"></div>

    <div class="container mx-auto p-4 md:p-8 flex flex-col items-center">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600">Perception Engine</h1>
            <p class="text-slate-600 mt-2 max-w-2xl mx-auto">Ubah persepsi visual bisnis Anda. Ciptakan gambar yang menjual hanya dalam beberapa klik.</p>
        </header>

        <main class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-6 md:p-8 relative overflow-hidden min-h-[500px]">

            <!-- Step 1: Unggah Kanvas -->
            <div id="step-1" class="step-card active">
                <div class="text-center">
                    <h2 class="text-2xl font-semibold mb-2">Langkah 1: Unggah "Kanvas" Anda</h2>
                    <p class="text-slate-500 mb-6">Pilih foto yang ingin Anda ubah persepsinya.</p>
                    <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-lg p-10 md:p-16 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors">
                        <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="mt-4 text-slate-600">Seret & lepas gambar di sini, atau <span class="font-semibold text-blue-600">klik untuk memilih file</span>.</p>
                        <p class="text-xs text-slate-500 mt-1">PNG, JPG, WEBP</p>
                    </div>
                    <input type="file" id="file-input" class="hidden" accept="image/png, image/jpeg, image/webp">
                </div>
                 <!-- Bank Inspirasi -->
                <div class="mt-10">
                    <h3 class="text-lg font-semibold text-center text-slate-700 mb-4">Butuh Inspirasi?</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="text-center p-2 rounded-lg hover:bg-slate-100 cursor-pointer" onclick="loadInspiration('cafe')">
                            <img src="https://placehold.co/400x300/E2E8F0/475569?text=Kafe+Sepi" alt="Kafe Sepi" class="rounded-md w-full h-auto aspect-video object-cover">
                            <p class="text-sm mt-2 font-medium">Kafe menjadi ramai</p>
                        </div>
                        <div class="text-center p-2 rounded-lg hover:bg-slate-100 cursor-pointer" onclick="loadInspiration('product')">
                            <img src="https://placehold.co/400x300/E2E8F0/475569?text=Produk+Polos" alt="Produk Polos" class="rounded-md w-full h-auto aspect-video object-cover">
                            <p class="text-sm mt-2 font-medium">Produk di alam</p>
                        </div>
                        <div class="text-center p-2 rounded-lg hover:bg-slate-100 cursor-pointer" onclick="loadInspiration('garage')">
                            <img src="https://placehold.co/400x300/E2E8F0/475569?text=Garasi+Kosong" alt="Garasi Kosong" class="rounded-md w-full h-auto aspect-video object-cover">
                            <p class="text-sm mt-2 font-medium">Garasi dengan mobil impian</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Pilih Simbol Visual & Edit -->
            <div id="step-2" class="step-card">
                 <button onclick="goToStep(1)" class="absolute top-4 left-6 text-sm text-slate-600 hover:text-blue-600 font-medium">‚Üê Kembali</button>
                <div class="grid md:grid-cols-2 gap-8 items-start">
                    <div class="text-center md:text-left">
                        <h2 class="text-2xl font-semibold mb-2">Langkah 2: Pilih Objek & Atur Detail</h2>
                        <p class="text-slate-500 mb-6">Pilih objek, atur detailnya, lalu tandai perspektifnya di gambar.</p>
                        
                        <div id="symbol-container">
                            <!-- Simbol akan di-generate oleh JS -->
                        </div>

                        <div id="edit-mode-container" class="mt-4">
                            <label class="block text-sm font-medium text-slate-700">Pilih Aksi:</label>
                            <div class="mt-2 grid grid-cols-2 gap-2">
                                <button id="add-btn" class="edit-mode-btn selected border-2 rounded-md p-2 text-sm font-medium text-center">
                                    ‚ûï Tambahkan Subjek
                                </button>
                                <button id="replace-btn" class="edit-mode-btn border-2 rounded-md p-2 text-sm font-medium text-center">
                                    üîÑ Ganti Objek
                                </button>
                            </div>
                        </div>

                        <div id="license-plate-container" class="mt-4" style="display: none;">
                             <label class="block text-sm font-medium text-slate-700">Plat Nomor (Opsional):</label>
                             <div class="grid grid-cols-3 gap-2 mt-1">
                                <input type="text" id="plate-1" placeholder="B" maxlength="2" class="text-center w-full px-2 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 uppercase">
                                <input type="text" id="plate-2" placeholder="1234" maxlength="4" class="text-center w-full px-2 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 uppercase">
                                <input type="text" id="plate-3" placeholder="XYZ" maxlength="3" class="text-center w-full px-2 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 uppercase">
                             </div>
                        </div>
                        
                        <div class="mt-4">
                            <label for="symbol-details" class="block text-sm font-medium text-slate-700">Detail Spesifik (opsional):</label>
                            <input type="text" id="symbol-details" placeholder="Contoh: Nissan GT-R putih, wanita tersenyum" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <p id="instruction-text" class="mt-6 text-blue-600 font-semibold animate-pulse">üëÜ Klik untuk menandai titik <strong id="marker-target-text">belakang</strong> objek.</p>
                    </div>
                    <div id="canvas-container" class="relative w-full rounded-lg overflow-hidden border-2 border-slate-200 cursor-crosshair">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Step 3: Generate & Sempurnakan -->
            <div id="step-3" class="step-card">
                <div class="text-center">
                    <h2 class="text-2xl font-semibold mb-2">Langkah 3: Generate & Sempurnakan</h2>
                    <p class="text-slate-500 mb-6">Inilah hasil kreasi persepsi baru Anda!</p>

                    <div id="loading-container" class="flex flex-col items-center justify-center p-8 text-center" style="display: none;">
                        <div class="loader"></div>
                        <p class="text-slate-600 mt-4 font-semibold">AI sedang meracik keajaiban... Mohon tunggu.</p>
                         <p class="text-slate-500 text-sm mt-1">Proses ini bisa memakan waktu hingga 1 menit.</p>
                    </div>

                    <div id="result-container" class="grid md:grid-cols-2 gap-4 items-center" style="display: none;">
                        <div>
                            <h3 class="font-semibold mb-2">Sebelum</h3>
                            <img id="original-image-preview" class="rounded-lg w-full">
                        </div>
                        <div>
                            <h3 class="font-semibold mb-2 text-blue-600">Sesudah</h3>
                            <img id="generated-image" class="rounded-lg w-full">
                        </div>
                    </div>
                    
                    <div id="action-buttons" class="mt-8 flex justify-center gap-4" style="display: none;">
                        <button onclick="window.location.reload()" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Mulai Lagi</button>
                        <a id="download-btn" href="#" download="perception_engine_result.png" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Unduh Hasil</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- State Management ---
        let currentStep = 1;
        let originalImage = null;
        let originalImageBase64 = null;
        let selectedSymbol = null;
        let editMode = 'add'; // 'add' or 'replace'
        let perspectivePoints = { back: null, front: null };
        let generatedPerspective = '';

        // --- DOM Elements ---
        const steps = {
            1: document.getElementById('step-1'),
            2: document.getElementById('step-2'),
            3: document.getElementById('step-3'),
        };
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const canvasContainer = document.getElementById('canvas-container');
        const symbolContainer = document.getElementById('symbol-container');
        const instructionText = document.getElementById('instruction-text');
        const markerTargetText = document.getElementById('marker-target-text');
        const loadingContainer = document.getElementById('loading-container');
        const resultContainer = document.getElementById('result-container');
        const actionButtons = document.getElementById('action-buttons');
        const downloadBtn = document.getElementById('download-btn');
        const addBtn = document.getElementById('add-btn');
        const replaceBtn = document.getElementById('replace-btn');
        const toast = document.getElementById('toast');
        const licensePlateContainer = document.getElementById('license-plate-container');

        // --- Symbol Data ---
        const symbols = [
            'Manusia', 'Mobil', 'Motor', 'Bangunan', 'Pohon', 
            'Meja', 'Kursi', 'Makanan', 'Minuman', 'Hewan', 
            'Tas', 'Jam Tangan', 'Gunung', 'Pantai', 'Langit'
        ];
        const vehicleSymbols = ['Mobil', 'Motor'];

        // --- Utility Functions ---
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function resetPerspective() {
            perspectivePoints = { back: null, front: null };
            redrawCanvas();
            markerTargetText.textContent = 'belakang';
            instructionText.innerHTML = `üëÜ Klik untuk menandai titik <strong id="marker-target-text">belakang</strong> objek.`;
            instructionText.classList.add('animate-pulse', 'text-blue-600');
            instructionText.classList.remove('text-green-600');
            let generateBtn = document.getElementById('generate-btn');
            if (generateBtn) generateBtn.remove();
        }

        // --- Event Listeners ---
        addBtn.addEventListener('click', () => {
            if (editMode === 'add') return;
            editMode = 'add';
            addBtn.classList.add('selected');
            replaceBtn.classList.remove('selected');
        });

        replaceBtn.addEventListener('click', () => {
            if (editMode === 'replace') return;
            editMode = 'replace';
            replaceBtn.classList.add('selected');
            addBtn.classList.remove('selected');
        });

        // --- Navigation ---
        function goToStep(stepNumber, callback) {
            if (stepNumber === 1) { // Reset state when going back to step 1
                window.location.reload();
                return;
            }
            steps[currentStep].classList.remove('active');
            currentStep = stepNumber;
            setTimeout(() => {
                 steps[currentStep].classList.add('active');
                 if (callback) callback(); // Execute callback after the step is visible
            }, 50);
            window.scrollTo(0, 0);
        }

        // --- Step 1: File Handling ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showToast('Harap pilih file gambar.');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImageBase64 = e.target.result;
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    populateSymbols();
                    // Pass the drawing logic as a callback to execute after step 2 is visible
                    goToStep(2, () => {
                        canvasContainer.style.aspectRatio = img.width / img.height;
                        const containerWidth = canvasContainer.clientWidth;
                        if (containerWidth === 0) {
                            showToast("Gagal memuat pratinjau gambar.");
                            return;
                        }
                        const scale = containerWidth / img.width;
                        canvas.width = containerWidth;
                        canvas.height = img.height * scale;
                        redrawCanvas();
                        document.getElementById('original-image-preview').src = originalImageBase64;
                    });
                };
                img.src = originalImageBase64;
            };
            reader.readAsDataURL(file);
        }

        function loadInspiration(type) {
            const inspirationUrls = {
                cafe: 'https://placehold.co/800x600/d1d5db/4b5563?text=Contoh+Kafe+Sepi',
                product: 'https://placehold.co/800x600/d1d5db/4b5563?text=Contoh+Produk',
                garage: 'https://placehold.co/800x600/d1d5db/4b5563?text=Contoh+Garasi'
            };
            fetch(inspirationUrls[type])
                .then(res => res.blob())
                .then(blob => {
                    const file = new File([blob], `${type}_inspiration.jpg`, { type: 'image/jpeg' });
                    handleFile(file);
                });
        }

        // --- Step 2: Symbol, Marker & Perspective ---
        function populateSymbols() {
            symbolContainer.innerHTML = `
                <p class="block text-sm font-medium text-slate-700 mb-2">Pilih kategori objek:</p>
                <div class="flex flex-wrap gap-2">
                    ${symbols.map(s => `<button class="symbol-btn border-2 border-slate-300 rounded-full px-4 py-1 text-sm font-medium hover:bg-slate-100">${s}</button>`).join('')}
                </div>`;
            document.querySelectorAll('.symbol-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.symbol-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedSymbol = btn.innerText;
                    licensePlateContainer.style.display = vehicleSymbols.includes(selectedSymbol) ? 'block' : 'none';
                    resetPerspective(); // Reset markers when symbol changes
                });
            });
        }

        function redrawCanvas() {
            if (!originalImage) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

            const { back, front } = perspectivePoints;
            if (back) drawMarker(back, 'B');
            if (front) drawMarker(front, 'F');
            if (back && front) drawArrow(back, front);
        }

        function drawMarker(point, label) {
            ctx.beginPath();
            ctx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
            ctx.fillStyle = 'rgba(59, 130, 246, 0.7)';
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = 'white';
            ctx.font = 'bold 10px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(label, point.x, point.y);
        }

        function drawArrow(p1, p2) {
            const headlen = 10;
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            const angle = Math.atan2(dy, dx);

            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.9)';
            ctx.lineWidth = 3;
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(p2.x, p2.y);
            ctx.lineTo(p2.x - headlen * Math.cos(angle - Math.PI / 6), p2.y - headlen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(p2.x - headlen * Math.cos(angle + Math.PI / 6), p2.y - headlen * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fillStyle = 'rgba(59, 130, 246, 0.9)';
            ctx.fill();
        }

        function getPerspectiveDescription(p1, p2) {
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            const angle = Math.atan2(-dy, dx) * 180 / Math.PI; // Invert y-axis for standard angle representation

            let angleDesc;
            if (angle >= -22.5 && angle < 22.5) angleDesc = "menghadap ke kanan";
            else if (angle >= 22.5 && angle < 67.5) angleDesc = "menghadap serong kanan-atas";
            else if (angle >= 67.5 && angle < 112.5) angleDesc = "menghadap ke atas (menjauh dari kamera)";
            else if (angle >= 112.5 && angle < 157.5) angleDesc = "menghadap serong kiri-atas";
            else if (angle >= 157.5 || angle < -157.5) angleDesc = "menghadap ke kiri";
            else if (angle >= -157.5 && angle < -112.5) angleDesc = "menghadap serong kiri-bawah";
            else if (angle >= -112.5 && angle < -67.5) angleDesc = "menghadap ke bawah (menuju kamera)";
            else if (angle >= -67.5 && angle < -22.5) angleDesc = "menghadap serong kanan-bawah";

            return `dilihat dari perspektif ${angleDesc}`;
        }

        canvas.addEventListener('click', (e) => {
            if (!selectedSymbol) {
                showToast('Harap pilih kategori objek terlebih dahulu!');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const point = { x: e.clientX - rect.left, y: e.clientY - rect.top };

            if (!perspectivePoints.back) {
                perspectivePoints.back = point;
                redrawCanvas();
                markerTargetText.textContent = 'depan';
                instructionText.innerHTML = `üëÜ Sekarang, klik untuk menandai titik <strong id="marker-target-text">depan</strong> objek.`;
            } else if (!perspectivePoints.front) {
                perspectivePoints.front = point;
                redrawCanvas();
                instructionText.innerHTML = '‚úÖ Perspektif diatur! Siap untuk generate. <button id="reset-marker" class="text-xs underline ml-2">Ulangi</button>';
                instructionText.classList.remove('animate-pulse', 'text-blue-600');
                instructionText.classList.add('text-green-600');
                
                document.getElementById('reset-marker').addEventListener('click', resetPerspective);

                if (!document.getElementById('generate-btn')) {
                    const generateBtn = document.createElement('button');
                    generateBtn.id = 'generate-btn';
                    generateBtn.className = 'w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors text-lg';
                    generateBtn.innerText = 'Generate Gambar Sekarang ‚Üí';
                    instructionText.parentNode.insertBefore(generateBtn, instructionText.nextSibling);
                    generateBtn.addEventListener('click', generateImage);
                }
            } else {
                 resetPerspective();
                 perspectivePoints.back = point;
                 redrawCanvas();
                 markerTargetText.textContent = 'depan';
                 instructionText.innerHTML = `üëÜ Sekarang, klik untuk menandai titik <strong id="marker-target-text">depan</strong> objek.`;
            }
        });

        // --- Step 3: Image Generation ---
        async function generateImage() {
            goToStep(3);
            loadingContainer.style.display = 'flex';
            resultContainer.style.display = 'none';
            actionButtons.style.display = 'none';

            const symbolDetails = document.getElementById('symbol-details').value;

            let licensePlate = '';
            if (vehicleSymbols.includes(selectedSymbol)) {
                const p1 = document.getElementById('plate-1').value;
                const p2 = document.getElementById('plate-2').value;
                const p3 = document.getElementById('plate-3').value;
                if (p1 || p2 || p3) licensePlate = ` dengan plat nomor ${p1} ${p2} ${p3}`.trim();
            }

            const fullSubjectDescription = `${symbolDetails || selectedSymbol}${licensePlate}`;
            generatedPerspective = getPerspectiveDescription(perspectivePoints.back, perspectivePoints.front);

            const realismRules = "ultra photorealistic, 8k, match the lighting, shadows, and perspective of the original photo perfectly. Do not change the background. Blend seamlessly.";
            let promptText;
            if (editMode === 'add') {
                promptText = `INSTRUCTION: Add a new subject to the image.
                TARGET_LOCATION: The area between the 'B' (back) and 'F' (front) markers, following the arrow's direction.
                SUBJECT_DESCRIPTION: A ${fullSubjectDescription}, ${generatedPerspective}.
                REALISM_RULES: ${realismRules}`;
            } else {
                promptText = `INSTRUCTION: Identify the existing object at the location and replace it.
                TARGET_LOCATION: The area between the 'B' (back) and 'F' (front) markers, following the arrow's direction.
                REPLACEMENT_SUBJECT_DESCRIPTION: A ${fullSubjectDescription}, ${generatedPerspective}.
                REALISM_RULES: ${realismRules}`;
            }
            
            const maskCanvas = document.createElement('canvas');
            maskCanvas.width = canvas.width;
            maskCanvas.height = canvas.height;
            const maskCtx = maskCanvas.getContext('2d');
            maskCtx.fillStyle = 'black';
            maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
            maskCtx.globalCompositeOperation = 'destination-out';
            
            const midPoint = { 
                x: (perspectivePoints.back.x + perspectivePoints.front.x) / 2,
                y: (perspectivePoints.back.y + perspectivePoints.front.y) / 2
            };
            const radius = Math.hypot(perspectivePoints.front.x - perspectivePoints.back.x, perspectivePoints.front.y - perspectivePoints.back.y) / 2 + 20; // Radius based on line length
            maskCtx.beginPath();
            maskCtx.arc(midPoint.x, midPoint.y, radius, 0, 2 * Math.PI);
            maskCtx.fill();
            const maskImageBase64 = maskCanvas.toDataURL('image/png').split(',')[1];

            const apiKey = "AIzaSyDXyUU4B21GxpUZLoUJfxHruFBqbI-BIHk"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [
                        { "text": promptText },
                        { "inlineData": { "mimeType": "image/png", "data": originalImageBase64.split(',')[1] } },
                        { "inlineData": { "mimeType": "image/png", "data": maskImageBase64 } }
                    ]
                }],
                generationConfig: {
                  responseModalities: ["IMAGE"]
                }
            };

            try {
                let retries = 3;
                let response;
                while (retries > 0) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    retries--;
                    if (retries > 0) await new Promise(res => setTimeout(res, 2000));
                }

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) throw new Error('No image data in API response.');

                const imageUrl = `data:image/png;base64,${base64Data}`;
                document.getElementById('generated-image').src = imageUrl;
                downloadBtn.href = imageUrl;

                loadingContainer.style.display = 'none';
                resultContainer.style.display = 'grid';
                actionButtons.style.display = 'flex';

            } catch (error) {
                console.error('Error generating image:', error);
                loadingContainer.innerHTML = `
                    <p class="text-red-500 font-semibold">Oops! Terjadi kesalahan saat generate gambar.</p>
                    <p class="text-slate-500 text-sm mt-2">Silakan coba lagi atau ubah detail Anda.</p>
                    <button onclick="goToStep(2)" class="mt-4 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg">Kembali</button>
                `;
            }
        }
        
        // Make loadInspiration globally accessible
        window.loadInspiration = loadInspiration;
    </script>
</body>
</html>


